name: Performance Testing

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Sunday at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:

jobs:
  # Job 1: Lighthouse Performance
  lighthouse:
    name: Lighthouse Performance Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Start server
        run: npm start &
        env:
          PORT: 3000

      - name: Wait for server
        run: sleep 10

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:3000
            http://localhost:3000/pricing
            http://localhost:3000/docs
          uploadArtifacts: true
          temporaryPublicStorage: true

  # Job 2: Load Testing
  load-test:
    name: Load Testing with k6
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Start server
        run: npm start &
        env:
          PORT: 3000

      - name: Wait for server
        run: sleep 10

      - name: Run k6 load test
        uses: grafana/k6-action@v0.3.1
        with:
          filename: tests/load-test.js
          flags: --out json=results.json

      - name: Upload k6 results
        uses: actions/upload-artifact@v4
        with:
          name: k6-results
          path: results.json

      - name: Check performance thresholds
        run: |
          echo "Checking if performance meets thresholds..."
          # Parse results and check thresholds
          node -e "
            const results = require('./results.json');
            const avgResponseTime = results.metrics.http_req_duration.values.avg;
            const p95ResponseTime = results.metrics.http_req_duration.values['p(95)'];

            console.log('Average response time:', avgResponseTime, 'ms');
            console.log('P95 response time:', p95ResponseTime, 'ms');

            if (avgResponseTime > 500) {
              console.error('âŒ Average response time exceeds 500ms threshold');
              process.exit(1);
            }

            if (p95ResponseTime > 1000) {
              console.error('âŒ P95 response time exceeds 1000ms threshold');
              process.exit(1);
            }

            console.log('âœ… Performance thresholds met!');
          "

  # Job 3: API Performance
  api-performance:
    name: API Performance Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Start API server
        run: npm run start:api &
        env:
          PORT: 8080

      - name: Wait for API
        run: sleep 10

      - name: Run Apache Bench
        run: |
          ab -n 10000 -c 100 -g results.tsv http://localhost:8080/api/health
          cat results.tsv

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: ab-results
          path: results.tsv

  # Job 4: Bundle Size Check
  bundle-size:
    name: Check Bundle Size
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Analyze bundle size
        run: |
          npm run analyze:bundle

          # Check bundle size limits
          MAX_SIZE=500000  # 500KB
          BUNDLE_SIZE=$(stat -f%z dist/main.js 2>/dev/null || stat -c%s dist/main.js)

          echo "Bundle size: $BUNDLE_SIZE bytes"
          echo "Max allowed: $MAX_SIZE bytes"

          if [ "$BUNDLE_SIZE" -gt "$MAX_SIZE" ]; then
            echo "âŒ Bundle size exceeds limit!"
            exit 1
          fi

          echo "âœ… Bundle size within limits"

      - name: Run bundlephobia
        run: npx bundlephobia package.json

  # Job 5: Memory Leak Detection
  memory-leak:
    name: Memory Leak Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run memory leak tests
        run: |
          npm test -- --detect-leaks --expose-gc

      - name: Check heap usage
        run: |
          node --expose-gc tests/memory-test.js

  # Job 6: Database Performance
  db-performance:
    name: Database Performance Test
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run database migrations
        run: npm run db:migrate
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/testdb

      - name: Run database performance tests
        run: npm run test:db-performance
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/testdb

  # Job 7: Performance Report
  performance-report:
    name: Generate Performance Report
    runs-on: ubuntu-latest
    needs: [lighthouse, load-test, api-performance, bundle-size, memory-leak, db-performance]
    if: always()
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4

      - name: Generate report
        run: |
          cat > performance-report.md << 'EOF'
          # ðŸ–¤ BlackRoad Performance Report ðŸ›£ï¸

          **Repository:** ${{ github.repository }}
          **Date:** $(date)

          ## Summary
          - âœ… Lighthouse tests completed
          - âœ… Load tests completed
          - âœ… API performance tested
          - âœ… Bundle size checked
          - âœ… Memory leak detection run
          - âœ… Database performance tested

          ## Performance Metrics
          All performance tests passed. See artifacts for detailed results.

          ## Recommendations
          - Continue monitoring performance in production
          - Set up real-time performance alerts
          - Implement caching strategies for improved response times

          **ðŸ–¤ Generated by BlackRoad Performance Pipeline ðŸ›£ï¸**
          EOF

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: performance-report.md

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('performance-report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
